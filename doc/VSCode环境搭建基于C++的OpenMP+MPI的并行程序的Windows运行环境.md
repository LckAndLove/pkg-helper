# VSCode环境搭建基于C/C++的OpenMP+MPI的并行程序的Windows运行环境

------

## 环境搭建

### 1. 安装 MSYS2

1. 前往 [MSYS2 官方网站](https://www.msys2.org/) 下载并安装 MSYS2。
2. 安装完成后，打开 `MSYS2`或者`UCRT64` 终端。

### 2. 安装开发工具链

终端中运行以下命令来安装开发工具链：

```sh
pacman -S --needed base-devel mingw-w64-ucrt-x86_64-toolchain
```

### 3. 安装 MS MPI

通过以下命令安装 MS MPI：

```sh
pacman -S mingw-w64-ucrt-x86_64-msmpi
```

### 4. 安装 OpenMP 支持

通过以下命令安装 OpenMP 支持：

```sh
pacman -S mingw-w64-ucrt-x86_64-llvm-openmp
```

### 5. 添加环境变量

将`MSYS2`的安装路径下的`ucrt64`文件夹中的`bin`、`lib`文件夹所在**路径**添加到本机**环境变量**中。

### 6. 下载并安装 MS MPI（Windows 环境）

1. 打开 [MS MPI 下载页面](https://www.microsoft.com/en-US/download/details.aspx?id=57467)。
2. 下载并安装以下两个文件：
   - **`msmpisetup.exe`**：主安装程序，用于安装 MPI 运行时环境。
   - **`msmpisdk.msi`**：MPI 开发工具包，包含头文件、库文件和示例程序。（可选）

---

## VSCode 配置

### 1. 安装插件

1. 打开 **VSCode**。
2. 在左侧的活动栏中点击 **扩展** 图标（或者按 `Ctrl + Shift + X`）。
3. 在搜索框中输入 **C/C++**，选择 **C/C++** 插件（由 Microsoft 提供），然后点击 **安装**。

### 2. 创建并编写 Hello World 程序

由于你已经安装了 OpenMP 和 MPI 环境，接下来使用它们来编写一个并行的 `Hello World` 程序。

1. 在 VSCode 中创建一个新的文件，命名为 `hello.cpp`。
2. 输入以下代码：

```cpp
// 这个程序使用 MPI 来获取进程的编号，并使用 OpenMP 来打印每个线程的信息。
#include <iostream>
#include <omp.h>
#include <mpi.h>

int main(int argc, char* argv[]) {
    // 初始化 MPI
    MPI_Init(&argc, &argv);

    int world_size, world_rank;
    MPI_Comm_size(MPI_COMM_WORLD, &world_size);
    MPI_Comm_rank(MPI_COMM_WORLD, &world_rank);

    // 使用 OpenMP 打印每个进程的信息
    #pragma omp parallel
    {
        int thread_id = omp_get_thread_num();
        int num_threads = omp_get_num_threads();
        std::cout << "Hello from rank " << world_rank
                  << " of " << world_size
                  << " with thread " << thread_id
                  << " of " << num_threads << " threads" << std::endl;
    }

    // 结束 MPI
    MPI_Finalize();
    return 0;
}
```

### 3. 配置 VSCode 自动生成任务

1. 在 VSCode 中，点击 **运行** 按钮（或按 `Ctrl + Shift + D`），然后选择 **运行 C/C++ 文件**。
2. VSCode 会自动生成 `tasks.json` 配置文件，确保你选择的编译器已经安装并能够支持 OpenMP 和 MPI。

### 4. 配置 `tasks.json`

在生成的 `tasks.json` 文件的`args`中，按照编译器传递参数的格式链接所需要的库。

```json
{
    "tasks": [
        {
            "type": "cppbuild",
            "label": "C/C++: g++.exe build active file",
            "command": "D:\\msys2\\ucrt64\\bin\\g++.exe",//自己msys2的安装路径下编译器路径
            "args": [
                "-fdiagnostics-color=always",
                "-g",
                "${file}",
                "-lomp",//链接 openmp 库
                "-lmsmpi", // 链接 MS MPI 库
                "-o",
                "${fileDirname}\\${fileBasenameNoExtension}.exe"
            ],
            "options": {
                "cwd": "${fileDirname}"
            },
            "problemMatcher": [
                "$gcc"
            ],
            "group": {
                "kind": "build",
                "isDefault": true
            },
            "detail": "Task generated by Debugger."
        }
    ],
    "version": "2.0.0"
}
```

### 5. 添加头文件的查找路径

按下 `Ctrl + Shift + P` 打开 **命令面板**，在命令面板中输入并选择 **C++: Edit Configurations (UI)**，这将启动一个图形化的配置界面。**Include Path（包含路径）**在这里，将`msys2`的`ucrt64/include`的文件夹路径，添加到新的一行，并在末尾加上**。

例如：`D:/msys64/ucrt64/include/**`

### 6. 运行程序

1. 再次点击 **运行** 按钮，VSCode 会自动编译并运行程序。
2. 应该能够看到每个 MPI 进程和 OpenMP 线程的输出。